{% extends 'base.html' %}

{% block title %}Check In at {{ place.name }} - GhostPin{% endblock %}

{% block content %}
<div class="max-w-2xl mx-auto">
    <!-- Header -->
    <div class="text-center mb-8">
        <h1 class="text-3xl font-bold text-gray-900 mb-2">
            <i class="fas fa-map-pin text-green-600 mr-2"></i>
            Check In
        </h1>
        <p class="text-gray-600">Verify your visit to earn points and share your experience</p>
    </div>
    
    <!-- Place Info Card -->
    <div class="bg-white rounded-lg shadow-lg p-6 mb-8">
        <div class="flex items-start space-x-4">
            {% if place.image %}
                <img src="{{ place.image.url }}" alt="{{ place.name }}" class="w-20 h-20 rounded-lg object-cover flex-shrink-0">
            {% else %}
                <div class="w-20 h-20 bg-gradient-to-br from-green-400 to-blue-500 rounded-lg flex items-center justify-center text-2xl flex-shrink-0">
                    {{ place.category_icon }}
                </div>
            {% endif %}
            
            <div class="flex-1">
                <h2 class="text-xl font-bold text-gray-900 mb-1">{{ place.name }}</h2>
                <p class="text-gray-600 text-sm mb-2">{{ place.description|truncatewords:20 }}</p>
                
                <div class="flex flex-wrap items-center gap-3 text-sm">
                    <span class="bg-{{ place.category }}-100 text-{{ place.category }}-800 px-2 py-1 rounded-full">
                        {{ place.get_category_display }}
                    </span>
                    <span class="text-gray-500">
                        <i class="fas fa-signal mr-1"></i>
                        {{ place.get_difficulty_display }}
                    </span>
                    {% if place.average_rating > 0 %}
                        <span class="text-gray-500">
                            <i class="fas fa-star text-yellow-500 mr-1"></i>
                            {{ place.average_rating|floatformat:1 }}
                        </span>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    
    <!-- Check-in Form -->
    <div class="bg-white rounded-lg shadow-lg p-6">
        <h3 class="text-lg font-bold text-gray-900 mb-6">
            <i class="fas fa-camera text-blue-600 mr-2"></i>
            Complete Your Check-in
        </h3>
        
        <form method="post" enctype="multipart/form-data" class="space-y-6">
            {% csrf_token %}
            
            <!-- Photo Proof -->
            <div>
                <label for="{{ form.photo_proof.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                    <i class="fas fa-camera mr-1"></i>
                    Photo Proof (Optional but Recommended)
                </label>
                {{ form.photo_proof }}
                <p class="mt-2 text-sm text-gray-500">
                    Upload a photo of yourself at this location to verify your visit and earn bonus points!
                </p>
                
                <!-- Photo Preview -->
                <div id="photo-preview" class="mt-4 hidden">
                    <img id="preview-image" class="w-full max-w-md h-48 object-cover rounded-lg border-2 border-dashed border-gray-300">
                </div>
            </div>
            
            <!-- Notes -->
            <div>
                <label for="{{ form.notes.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                    <i class="fas fa-sticky-note mr-1"></i>
                    Your Experience
                </label>
                {{ form.notes }}
                <p class="mt-2 text-sm text-gray-500">
                    Share your thoughts, tips, or interesting observations about this place.
                </p>
            </div>
            
            <!-- Location Verification -->
            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                <div class="flex items-start space-x-3">
                    <i class="fas fa-info-circle text-blue-600 mt-1"></i>
                    <div>
                        <h4 class="font-semibold text-blue-900 mb-1">Location Verification</h4>
                        <p class="text-blue-800 text-sm mb-3">
                            We'll verify your location to ensure authentic check-ins. This helps maintain the quality of our community.
                        </p>
                        <button type="button" id="verify-location" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded text-sm transition-colors">
                            <i class="fas fa-crosshairs mr-1"></i>
                            Verify My Location
                        </button>
                        <div id="location-status" class="mt-2 text-sm"></div>
                    </div>
                </div>
            </div>
            
            <!-- Points Info -->
            <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                <div class="flex items-center space-x-3">
                    <i class="fas fa-coins text-green-600 text-xl"></i>
                    <div>
                        <h4 class="font-semibold text-green-900 mb-1">Points You'll Earn</h4>
                        <div class="text-green-800 text-sm space-y-1">
                            <div class="flex justify-between">
                                <span>Basic check-in:</span>
                                <span class="font-semibold">+10 points</span>
                            </div>
                            <div class="flex justify-between">
                                <span>With photo proof:</span>
                                <span class="font-semibold">+5 bonus points</span>
                            </div>
                            <div class="flex justify-between">
                                <span>Location verified:</span>
                                <span class="font-semibold">+5 bonus points</span>
                            </div>
                            <div class="border-t border-green-300 pt-1 mt-2">
                                <div class="flex justify-between font-bold">
                                    <span>Potential total:</span>
                                    <span>+20 points</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Submit Button -->
            <div class="flex space-x-4">
                <button type="submit" class="flex-1 bg-green-600 hover:bg-green-700 text-white font-semibold py-3 px-6 rounded-lg transition-colors">
                    <i class="fas fa-check-circle mr-2"></i>
                    Complete Check-in
                </button>
                <a href="{% url 'places:place_detail' place.pk %}" class="bg-gray-300 hover:bg-gray-400 text-gray-700 font-semibold py-3 px-6 rounded-lg transition-colors">
                    <i class="fas fa-times mr-2"></i>
                    Cancel
                </a>
            </div>
        </form>
    </div>
    
    <!-- Tips for Better Check-ins -->
    <div class="mt-8 bg-white rounded-lg shadow-lg p-6">
        <h3 class="text-lg font-bold text-gray-900 mb-4">
            <i class="fas fa-lightbulb text-yellow-500 mr-2"></i>
            Tips for Better Check-ins
        </h3>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm text-gray-600">
            <div class="flex items-start space-x-2">
                <i class="fas fa-camera text-green-500 mt-1"></i>
                <span>Take a clear photo showing you at the location</span>
            </div>
            <div class="flex items-start space-x-2">
                <i class="fas fa-map-marker-alt text-blue-500 mt-1"></i>
                <span>Enable location services for automatic verification</span>
            </div>
            <div class="flex items-start space-x-2">
                <i class="fas fa-pen text-purple-500 mt-1"></i>
                <span>Share interesting details or historical facts you learned</span>
            </div>
            <div class="flex items-start space-x-2">
                <i class="fas fa-clock text-orange-500 mt-1"></i>
                <span>Check in during your actual visit for authenticity</span>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Photo preview functionality
    document.getElementById('{{ form.photo_proof.id_for_label }}').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const preview = document.getElementById('photo-preview');
                const image = document.getElementById('preview-image');
                image.src = e.target.result;
                preview.classList.remove('hidden');
            };
            reader.readAsDataURL(file);
        }
    });
    
    // Location verification
    document.getElementById('verify-location').addEventListener('click', function() {
        const button = this;
        const status = document.getElementById('location-status');
        
        button.disabled = true;
        button.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i> Verifying...';
        status.innerHTML = '<span class="text-blue-600">Getting your location...</span>';
        
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                function(position) {
                    const userLat = position.coords.latitude;
                    const userLng = position.coords.longitude;
                    const placeLat = {{ place.latitude }};
                    const placeLng = {{ place.longitude }};
                    
                    // Calculate distance using Haversine formula
                    const R = 6371; // Earth's radius in km
                    const dLat = (placeLat - userLat) * Math.PI / 180;
                    const dLng = (placeLng - userLng) * Math.PI / 180;
                    const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                            Math.cos(userLat * Math.PI / 180) * Math.cos(placeLat * Math.PI / 180) *
                            Math.sin(dLng/2) * Math.sin(dLng/2);
                    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
                    const distance = R * c * 1000; // Distance in meters
                    
                    if (distance <= 100) { // Within 100 meters
                        status.innerHTML = '<span class="text-green-600"><i class="fas fa-check-circle mr-1"></i> Location verified! You\'re at the right place.</span>';
                        button.innerHTML = '<i class="fas fa-check-circle mr-1"></i> Location Verified';
                        button.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                        button.classList.add('bg-green-600', 'hover:bg-green-700');
                    } else {
                        status.innerHTML = `<span class="text-orange-600"><i class="fas fa-exclamation-triangle mr-1"></i> You're ${Math.round(distance)}m away from the place. Get closer for verification.</span>`;
                        button.innerHTML = '<i class="fas fa-crosshairs mr-1"></i> Try Again';
                        button.disabled = false;
                    }
                },
                function(error) {
                    status.innerHTML = '<span class="text-red-600"><i class="fas fa-times-circle mr-1"></i> Location access denied. You can still check in without verification.</span>';
                    button.innerHTML = '<i class="fas fa-crosshairs mr-1"></i> Verify My Location';
                    button.disabled = false;
                }
            );
        } else {
            status.innerHTML = '<span class="text-red-600">Geolocation is not supported by this browser.</span>';
            button.innerHTML = '<i class="fas fa-crosshairs mr-1"></i> Verify My Location';
            button.disabled = false;
        }
    });
</script>
{% endblock %}

