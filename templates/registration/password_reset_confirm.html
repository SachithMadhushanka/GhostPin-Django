{% extends 'base.html' %}

{% block title %}Set New Password - GhostPin{% endblock %}

{% block content %}
<div class="min-h-screen bg-gradient-to-br from-green-50 to-blue-100 flex items-center justify-center py-12 px-4 sm:px-6 lg:px-8">
    <div class="max-w-md w-full space-y-8">
        <!-- Header -->
        <div class="text-center">
            <div class="mx-auto h-16 w-16 bg-gradient-to-br from-green-400 to-blue-500 rounded-full flex items-center justify-center mb-6">
                <i class="fas fa-lock text-2xl text-white"></i>
            </div>
            {% if validlink %}
                <h2 class="text-3xl font-bold text-gray-900 mb-2">Set New Password</h2>
                <p class="text-gray-600">Enter your new password below</p>
            {% else %}
                <h2 class="text-3xl font-bold text-gray-900 mb-2">Invalid Reset Link</h2>
                <p class="text-gray-600">This password reset link is invalid or has expired</p>
            {% endif %}
        </div>

        {% if validlink %}
            <!-- Password Reset Form -->
            <div class="bg-white rounded-lg shadow-xl p-8">
                {% if form.errors %}
                    <div class="mb-6 bg-red-50 border border-red-200 rounded-md p-4">
                        <div class="flex">
                            <div class="flex-shrink-0">
                                <i class="fas fa-exclamation-circle text-red-400"></i>
                            </div>
                            <div class="ml-3">
                                <h3 class="text-sm font-medium text-red-800">
                                    Please correct the errors below
                                </h3>
                                <div class="mt-2 text-sm text-red-700">
                                    {% for field, errors in form.errors.items %}
                                        {% for error in errors %}
                                            <p>{{ error }}</p>
                                        {% endfor %}
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                    </div>
                {% endif %}

                <form method="post" class="space-y-6">
                    {% csrf_token %}
                    
                    <!-- New Password -->
                    <div>
                        <label for="{{ form.new_password1.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-lock text-blue-600 mr-1"></i>
                            New Password
                        </label>
                        <div class="relative">
                            {{ form.new_password1 }}
                            <button type="button" class="absolute inset-y-0 right-0 pr-3 flex items-center" onclick="togglePassword('{{ form.new_password1.id_for_label }}')">
                                <i class="fas fa-eye text-gray-400 hover:text-gray-600" id="eye-icon-1"></i>
                            </button>
                        </div>
                        {% if form.new_password1.errors %}
                            <p class="mt-1 text-sm text-red-600">{{ form.new_password1.errors.0 }}</p>
                        {% endif %}
                        
                        <!-- Password Strength Indicator -->
                        <div class="mt-2">
                            <div class="flex items-center space-x-2">
                                <div class="flex-1 bg-gray-200 rounded-full h-2">
                                    <div id="password-strength-bar" class="h-2 rounded-full transition-all duration-300"></div>
                                </div>
                                <span id="password-strength-text" class="text-xs text-gray-500">Weak</span>
                            </div>
                            <div class="mt-1 text-xs text-gray-500">
                                <div id="password-requirements" class="space-y-1">
                                    <div id="req-length" class="flex items-center">
                                        <i class="fas fa-times text-red-500 mr-1"></i>
                                        <span>At least 8 characters</span>
                                    </div>
                                    <div id="req-uppercase" class="flex items-center">
                                        <i class="fas fa-times text-red-500 mr-1"></i>
                                        <span>One uppercase letter</span>
                                    </div>
                                    <div id="req-lowercase" class="flex items-center">
                                        <i class="fas fa-times text-red-500 mr-1"></i>
                                        <span>One lowercase letter</span>
                                    </div>
                                    <div id="req-number" class="flex items-center">
                                        <i class="fas fa-times text-red-500 mr-1"></i>
                                        <span>One number</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Confirm New Password -->
                    <div>
                        <label for="{{ form.new_password2.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-lock text-blue-600 mr-1"></i>
                            Confirm New Password
                        </label>
                        <div class="relative">
                            {{ form.new_password2 }}
                            <button type="button" class="absolute inset-y-0 right-0 pr-3 flex items-center" onclick="togglePassword('{{ form.new_password2.id_for_label }}')">
                                <i class="fas fa-eye text-gray-400 hover:text-gray-600" id="eye-icon-2"></i>
                            </button>
                        </div>
                        {% if form.new_password2.errors %}
                            <p class="mt-1 text-sm text-red-600">{{ form.new_password2.errors.0 }}</p>
                        {% endif %}
                        <div id="password-match" class="mt-1 text-xs"></div>
                    </div>

                    <!-- Submit Button -->
                    <button type="submit" 
                            class="w-full bg-gradient-to-r from-green-500 to-blue-600 hover:from-green-600 hover:to-blue-700 text-white font-semibold py-3 px-4 rounded-md transition-all duration-200 transform hover:scale-105">
                        <i class="fas fa-check mr-2"></i>
                        Set New Password
                    </button>
                </form>

                <!-- Security Tips -->
                <div class="mt-6 bg-blue-50 rounded-lg p-4">
                    <div class="flex">
                        <div class="flex-shrink-0">
                            <i class="fas fa-shield-alt text-blue-400"></i>
                        </div>
                        <div class="ml-3">
                            <h3 class="text-sm font-medium text-blue-800">Password Security Tips</h3>
                            <div class="mt-2 text-sm text-blue-700">
                                <ul class="list-disc list-inside space-y-1">
                                    <li>Use a unique password you haven't used elsewhere</li>
                                    <li>Include a mix of letters, numbers, and symbols</li>
                                    <li>Avoid personal information like names or dates</li>
                                    <li>Consider using a password manager</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        {% else %}
            <!-- Invalid Link -->
            <div class="bg-white rounded-lg shadow-xl p-8">
                <div class="text-center">
                    <div class="mx-auto h-16 w-16 bg-red-100 rounded-full flex items-center justify-center mb-6">
                        <i class="fas fa-exclamation-triangle text-red-600 text-2xl"></i>
                    </div>
                    
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Reset Link Invalid</h3>
                    
                    <div class="space-y-4 text-sm text-gray-600">
                        <p>This password reset link is either invalid or has expired. This could happen if:</p>
                        
                        <ul class="list-disc list-inside space-y-2 text-left max-w-sm mx-auto">
                            <li>The link is more than 24 hours old</li>
                            <li>You've already used this link to reset your password</li>
                            <li>The link was copied incorrectly</li>
                            <li>You've requested a new password reset since this link was sent</li>
                        </ul>
                    </div>
                    
                    <div class="mt-8 space-y-3">
                        <a href="{% url 'password_reset' %}" 
                           class="w-full inline-flex justify-center items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 transition-colors">
                            <i class="fas fa-redo mr-2"></i>
                            Request New Reset Link
                        </a>
                        
                        <a href="{% url 'login' %}" 
                           class="w-full inline-flex justify-center items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 transition-colors">
                            <i class="fas fa-arrow-left mr-2"></i>
                            Back to Sign In
                        </a>
                    </div>
                </div>
            </div>
        {% endif %}

        <!-- Help Section -->
        <div class="bg-white rounded-lg shadow-lg p-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-4 text-center">
                <i class="fas fa-question-circle text-yellow-500 mr-2"></i>
                Need Help?
            </h3>
            
            <div class="text-center text-sm text-gray-600">
                <p class="mb-4">
                    If you're having trouble resetting your password, our support team is here to help.
                </p>
                
                <div class="space-y-2">
                    <a href="mailto:support@ghostpin.com" 
                       class="inline-flex items-center text-blue-600 hover:text-blue-800 transition-colors">
                        <i class="fas fa-envelope mr-2"></i>
                        support@ghostpin.com
                    </a>
                    
                    <div class="text-xs text-gray-500">
                        We typically respond within 24 hours
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Toggle password visibility
    function togglePassword(inputId) {
        const input = document.getElementById(inputId);
        const eyeIcon = document.getElementById('eye-icon-' + inputId.slice(-1));
        
        if (input.type === 'password') {
            input.type = 'text';
            eyeIcon.classList.remove('fa-eye');
            eyeIcon.classList.add('fa-eye-slash');
        } else {
            input.type = 'password';
            eyeIcon.classList.remove('fa-eye-slash');
            eyeIcon.classList.add('fa-eye');
        }
    }
    
    // Password strength checker
    function checkPasswordStrength(password) {
        let strength = 0;
        const requirements = {
            length: password.length >= 8,
            uppercase: /[A-Z]/.test(password),
            lowercase: /[a-z]/.test(password),
            number: /\d/.test(password)
        };
        
        // Update requirement indicators
        Object.keys(requirements).forEach(req => {
            const element = document.getElementById('req-' + req);
            if (element) {
                const icon = element.querySelector('i');
                
                if (requirements[req]) {
                    icon.classList.remove('fa-times', 'text-red-500');
                    icon.classList.add('fa-check', 'text-green-500');
                    strength++;
                } else {
                    icon.classList.remove('fa-check', 'text-green-500');
                    icon.classList.add('fa-times', 'text-red-500');
                }
            }
        });
        
        // Update strength bar and text
        const strengthBar = document.getElementById('password-strength-bar');
        const strengthText = document.getElementById('password-strength-text');
        
        if (strengthBar && strengthText) {
            const strengthLevels = [
                { width: '25%', color: 'bg-red-500', text: 'Weak' },
                { width: '50%', color: 'bg-yellow-500', text: 'Fair' },
                { width: '75%', color: 'bg-blue-500', text: 'Good' },
                { width: '100%', color: 'bg-green-500', text: 'Strong' }
            ];
            
            const level = strengthLevels[Math.min(strength - 1, 3)] || strengthLevels[0];
            
            strengthBar.style.width = level.width;
            strengthBar.className = `h-2 rounded-full transition-all duration-300 ${level.color}`;
            strengthText.textContent = level.text;
            strengthText.className = `text-xs ${level.color.replace('bg-', 'text-')}`;
        }
    }
    
    // Password confirmation checker
    function checkPasswordMatch() {
        const password1 = document.querySelector('input[name="new_password1"]');
        const password2 = document.querySelector('input[name="new_password2"]');
        const matchElement = document.getElementById('password-match');
        
        if (password1 && password2 && matchElement) {
            const pass1 = password1.value;
            const pass2 = password2.value;
            
            if (pass2.length > 0) {
                if (pass1 === pass2) {
                    matchElement.innerHTML = '<i class="fas fa-check text-green-500 mr-1"></i><span class="text-green-600">Passwords match</span>';
                } else {
                    matchElement.innerHTML = '<i class="fas fa-times text-red-500 mr-1"></i><span class="text-red-600">Passwords do not match</span>';
                }
            } else {
                matchElement.innerHTML = '';
            }
        }
    }
    
    // Event listeners
    document.addEventListener('DOMContentLoaded', function() {
        const password1 = document.querySelector('input[name="new_password1"]');
        const password2 = document.querySelector('input[name="new_password2"]');
        
        if (password1) {
            password1.addEventListener('input', function(e) {
                checkPasswordStrength(e.target.value);
                checkPasswordMatch();
            });
            
            // Focus on password field
            password1.focus();
            
            // Initialize password strength
            checkPasswordStrength('');
        }
        
        if (password2) {
            password2.addEventListener('input', checkPasswordMatch);
        }
    });
    
    // Form validation
    document.querySelector('form')?.addEventListener('submit', function(e) {
        const password1 = document.querySelector('input[name="new_password1"]')?.value;
        const password2 = document.querySelector('input[name="new_password2"]')?.value;
        
        if (password1 !== password2) {
            e.preventDefault();
            alert('Passwords do not match. Please check and try again.');
            return false;
        }
        
        // Check password strength
        const strengthText = document.getElementById('password-strength-text')?.textContent;
        if (strengthText === 'Weak') {
            if (!confirm('Your password is weak. Are you sure you want to continue?')) {
                e.preventDefault();
                return false;
            }
        }
        
        // Show loading state
        const submitBtn = document.querySelector('button[type="submit"]');
        if (submitBtn) {
            const originalText = submitBtn.innerHTML;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Setting Password...';
            submitBtn.disabled = true;
            
            // Re-enable button after 5 seconds (in case of error)
            setTimeout(() => {
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
            }, 5000);
        }
    });
</script>
{% endblock %}

