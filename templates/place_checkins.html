{% extends 'base.html' %}

{% block title %}Check-ins at {{ place.name }} - GhostPin{% endblock %}

{% block content %}
<!-- CSRF Token for AJAX requests -->
{% csrf_token %}

<div class="max-w-6xl mx-auto">
    <!-- Header -->
    <div class="mb-8">
        <div class="flex items-center justify-between">
            <div>
                <h1 class="text-3xl font-bold text-gray-900 mb-2">
                    <i class="fas fa-map-marker-alt text-red-600 mr-2"></i>
                    Check-ins at {{ place.name }}
                </h1>
                <p class="text-gray-600">
                    {{ checkins.count }} visitor{{ checkins.count|pluralize }} {{ checkins.count|pluralize:"has,have" }} checked in at this location
                </p>
            </div>
            
            <div class="flex space-x-3">
                <a href="{% url 'places:place_detail' place.pk %}" class="inline-flex items-center text-green-600 hover:text-green-700 font-medium">
                    <i class="fas fa-eye mr-2"></i> View Place
                </a>
                {% if user.is_authenticated %}
                    <a href="{% url 'places:check_in' place.pk %}" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors">
                        <i class="fas fa-map-pin mr-2"></i> Check In Here
                    </a>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Place Summary Card -->
    <div class="bg-white rounded-lg shadow-lg overflow-hidden mb-8">
        <div class="flex flex-col md:flex-row">
            <!-- Place Image -->
            <div class="md:w-1/3 h-64 md:h-auto">
                {% if place.image %}
                    <img src="{{ place.image.url }}" alt="{{ place.name }}" 
                         class="w-full h-full object-cover">
                {% else %}
                    <div class="w-full h-full bg-gradient-to-br from-green-400 to-blue-500 flex items-center justify-center text-white text-4xl">
                        {{ place.category_icon|default:"üèõÔ∏è" }}
                    </div>
                {% endif %}
            </div>
            
            <!-- Place Details -->
            <div class="md:w-2/3 p-6">
                <h2 class="text-2xl font-bold text-gray-900 mb-3">{{ place.name }}</h2>
                <p class="text-gray-600 mb-4">{{ place.description|truncatewords:30 }}</p>
                
                <!-- Stats Grid -->
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4">
                    <div class="text-center p-3 bg-blue-50 rounded-lg">
                        <div class="text-2xl font-bold text-blue-600">{{ checkins.count }}</div>
                        <div class="text-sm text-gray-600">Check-ins</div>
                    </div>
                    <div class="text-center p-3 bg-green-50 rounded-lg">
                        <div class="text-2xl font-bold text-green-600">{{ unique_visitors|default:checkins.count }}</div>
                        <div class="text-sm text-gray-600">Visitors</div>
                    </div>
                    <div class="text-center p-3 bg-yellow-50 rounded-lg">
                        <div class="text-2xl font-bold text-yellow-600">{{ place.average_rating|floatformat:1|default:"N/A" }}</div>
                        <div class="text-sm text-gray-600">Rating</div>
                    </div>
                    <div class="text-center p-3 bg-purple-50 rounded-lg">
                        <div class="text-2xl font-bold text-purple-600">{{ verified_checkins|default:0 }}</div>
                        <div class="text-sm text-gray-600">Verified</div>
                    </div>
                </div>
                
                <!-- Tags -->
                <div class="flex flex-wrap gap-2">
                    <span class="bg-blue-100 text-blue-800 text-sm px-3 py-1 rounded-full">
                        <i class="fas fa-tag mr-1"></i>
                        {{ place.get_category_display }}
                    </span>
                    <span class="bg-orange-100 text-orange-800 text-sm px-3 py-1 rounded-full">
                        <i class="fas fa-signal mr-1"></i>
                        {{ place.get_difficulty_display }}
                    </span>
                    <span class="bg-gray-100 text-gray-800 text-sm px-3 py-1 rounded-full">
                        <i class="fas fa-map-marker-alt mr-1"></i>
                        {{ place.location }}
                    </span>
                </div>
            </div>
        </div>
    </div>

    <!-- Filters and Sorting -->
    <div class="bg-white rounded-lg shadow-lg p-6 mb-8">
        <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
            <h3 class="text-lg font-semibold text-gray-900">
                <i class="fas fa-filter text-purple-600 mr-2"></i>
                Filter & Sort Check-ins
            </h3>
            
            <div class="flex flex-wrap gap-3">
                <!-- Sort Options -->
                <select id="sort-select" class="px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" onchange="sortCheckins()">
                    <option value="newest">Newest First</option>
                    <option value="oldest">Oldest First</option>
                    <option value="verified">Verified First</option>
                    <option value="photos">With Photos</option>
                    <option value="rating">Highest Rated</option>
                </select>
                
                <!-- Filter Buttons -->
                <button class="filter-btn active" data-filter="all" onclick="filterCheckins('all')">
                    All ({{ checkins.count }})
                </button>
                <button class="filter-btn" data-filter="verified" onclick="filterCheckins('verified')">
                    Verified ({{ verified_checkins|default:0 }})
                </button>
                <button class="filter-btn" data-filter="photos" onclick="filterCheckins('photos')">
                    With Photos ({{ photo_checkins|default:0 }})
                </button>
                <button class="filter-btn" data-filter="recent" onclick="filterCheckins('recent')">
                    Recent (7 days)
                </button>
            </div>
        </div>
    </div>

    <!-- Check-ins List -->
    {% if checkins %}
        <div class="space-y-8" id="checkins-list">
            {% for checkin in checkins %}
                <div class="checkin-item bg-white rounded-lg shadow-lg overflow-hidden" 
                     data-verified="{{ checkin.location_verified|default:checkin.location_verified|yesno:'true,false' }}"
                     data-has-photo="{{ checkin.photo|default:checkin.photo_proof|yesno:'true,false' }}"
                     data-date="{{ checkin.created_at|date:'Y-m-d' }}"
                     data-rating="{{ checkin.rating|default:0 }}">
                    
                    <!-- Check-in Header -->
                    <div class="p-6 border-b border-gray-100">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center space-x-4">
                                <!-- User Avatar -->
                                <div class="w-12 h-12 bg-gradient-to-br from-blue-400 to-purple-500 rounded-full flex items-center justify-center text-white font-bold text-lg">
                                    {{ checkin.user.username|first|upper }}
                                </div>
                                
                                <!-- User Info -->
                                <div>
                                    <h3 class="text-lg font-semibold text-gray-900">
                                        <a href="{% url 'places:profile' checkin.user.username %}" class="hover:text-blue-600 transition-colors">
                                            {{ checkin.user.username }}
                                        </a>
                                    </h3>
                                    <p class="text-gray-600 text-sm">
                                        <i class="fas fa-calendar mr-1"></i>
                                        {{ checkin.created_at|date:"F j, Y" }} at {{ checkin.created_at|date:"g:i a" }}
                                        <span class="mx-2">‚Ä¢</span>
                                        <i class="fas fa-clock mr-1"></i>
                                        {{ checkin.created_at|timesince }} ago
                                    </p>
                                </div>
                            </div>
                            
                            <!-- Status Badges -->
                            <div class="flex items-center space-x-2">
                                {% if checkin.location_verified|default:checkin.location_verified %}
                                    <span class="bg-green-100 text-green-800 px-3 py-1 rounded-full text-sm font-semibold">
                                        <i class="fas fa-check-circle mr-1"></i>
                                        Verified
                                    </span>
                                {% endif %}
                                
                                {% if checkin.photo|default:checkin.photo_proof %}
                                    <span class="bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-sm font-semibold">
                                        <i class="fas fa-camera mr-1"></i>
                                        Photo
                                    </span>
                                {% endif %}
                                
                                <a href="{% url 'places:checkin_detail' checkin.pk %}" class="text-blue-600 hover:text-blue-800 text-sm font-medium">
                                    <i class="fas fa-external-link-alt mr-1"></i>
                                    View Details
                                </a>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Check-in Content -->
                    <div class="p-6">
                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                            <!-- Left Column: Photo -->
                            {% if checkin.photo|default:checkin.photo_proof %}
                                <div class="lg:col-span-1">
                                    <div class="relative">
                                        <img src="{{ checkin.photo.url|default:checkin.photo_proof.url }}" 
                                             alt="Check-in photo by {{ checkin.user.username }}" 
                                             class="w-full h-64 object-cover rounded-lg shadow-md cursor-pointer hover:shadow-lg transition-shadow"
                                             onclick="openPhotoModal(this.src, '{{ checkin.user.username }}', '{{ checkin.created_at|date:"F j, Y" }}')">
                                        
                                        <!-- Photo Overlay -->
                                        <div class="absolute inset-0 bg-black bg-opacity-0 hover:bg-opacity-20 transition-all duration-200 rounded-lg flex items-center justify-center">
                                            <i class="fas fa-search-plus text-white text-2xl opacity-0 hover:opacity-100 transition-opacity"></i>
                                        </div>
                                    </div>
                                </div>
                            {% endif %}
                            
                            <!-- Right Column: Details -->
                            <div class="{% if checkin.photo|default:checkin.photo_proof %}lg:col-span-2{% else %}lg:col-span-3{% endif %}">
                                <!-- Check-in Details Grid -->
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                                    <div class="space-y-3">
                                        <div class="flex items-center justify-between py-2 border-b border-gray-100">
                                            <span class="text-gray-600 font-medium">Points Earned</span>
                                            <span class="font-bold text-green-600">
                                                <i class="fas fa-coins mr-1"></i>
                                                +{{ checkin.points_earned|default:checkin.points_awarded|default:10 }}
                                            </span>
                                        </div>
                                        
                                        <div class="flex items-center justify-between py-2 border-b border-gray-100">
                                            <span class="text-gray-600 font-medium">Location Verified</span>
                                            {% if checkin.location_verified|default:checkin.location_verified %}
                                                <span class="text-green-600 font-semibold">
                                                    <i class="fas fa-check-circle mr-1"></i>
                                                    Yes
                                                </span>
                                            {% else %}
                                                <span class="text-red-600 font-semibold">
                                                    <i class="fas fa-times-circle mr-1"></i>
                                                    No
                                                </span>
                                            {% endif %}
                                        </div>
                                        
                                        {% if checkin.weather %}
                                            <div class="flex items-center justify-between py-2 border-b border-gray-100">
                                                <span class="text-gray-600 font-medium">Weather</span>
                                                <span class="font-semibold text-gray-900">
                                                    <i class="fas fa-cloud-sun text-yellow-500 mr-1"></i>
                                                    {{ checkin.weather }}
                                                </span>
                                            </div>
                                        {% endif %}
                                    </div>
                                    
                                    <div class="space-y-3">
                                        {% if checkin.rating %}
                                            <div class="flex items-center justify-between py-2 border-b border-gray-100">
                                                <span class="text-gray-600 font-medium">Rating</span>
                                                <div class="flex items-center space-x-1">
                                                    {% for i in "12345" %}
                                                        {% if forloop.counter <= checkin.rating %}
                                                            <i class="fas fa-star text-yellow-400"></i>
                                                        {% else %}
                                                            <i class="far fa-star text-gray-300"></i>
                                                        {% endif %}
                                                    {% endfor %}
                                                </div>
                                            </div>
                                        {% endif %}
                                        
                                        {% if checkin.visit_duration %}
                                            <div class="flex items-center justify-between py-2 border-b border-gray-100">
                                                <span class="text-gray-600 font-medium">Visit Duration</span>
                                                <span class="font-semibold text-gray-900">
                                                    <i class="fas fa-clock mr-1"></i>
                                                    {{ checkin.visit_duration }} minutes
                                                </span>
                                            </div>
                                        {% endif %}
                                        
                                        {% if checkin.companions %}
                                            <div class="flex items-center justify-between py-2 border-b border-gray-100">
                                                <span class="text-gray-600 font-medium">Companions</span>
                                                <span class="font-semibold text-gray-900">
                                                    <i class="fas fa-users mr-1"></i>
                                                    {{ checkin.companions }}
                                                </span>
                                            </div>
                                        {% endif %}
                                    </div>
                                </div>
                                
                                <!-- Notes Section -->
                                {% if checkin.notes %}
                                    <div class="bg-gray-50 rounded-lg p-4 mb-4">
                                        <h4 class="font-semibold text-gray-900 mb-2">
                                            <i class="fas fa-sticky-note text-yellow-600 mr-2"></i>
                                            Visitor Notes
                                        </h4>
                                        <p class="text-gray-700 italic">"{{ checkin.notes }}"</p>
                                    </div>
                                {% endif %}
                                
                                <!-- Interaction Buttons -->
                                <div class="flex items-center justify-between">
                                    <div class="flex items-center space-x-4">
                                        <!-- Like Button -->
                                        <button class="flex items-center space-x-2 text-gray-600 hover:text-red-600 transition-colors" onclick="likeCheckin('{{ checkin.id }}')">
                                            <i class="far fa-heart"></i>
                                            <span class="text-sm">{{ checkin.likes|default:0 }}</span>
                                        </button>
                                        
                                        <!-- Comment Count -->
                                        <a href="{% url 'places:checkin_detail' checkin.pk %}#comments" class="flex items-center space-x-2 text-gray-600 hover:text-blue-600 transition-colors">
                                            <i class="far fa-comment"></i>
                                            <span class="text-sm">{{ checkin.comments_count|default:0 }} comment{{ checkin.comments_count|default:0|pluralize }}</span>
                                        </a>
                                        
                                        <!-- Share Button -->
                                        <button class="flex items-center space-x-2 text-gray-600 hover:text-green-600 transition-colors" onclick="shareCheckin('{{ checkin.id }}')">
                                            <i class="fas fa-share"></i>
                                            <span class="text-sm">Share</span>
                                        </button>
                                    </div>
                                    
                                    <!-- Timestamp -->
                                    <div class="text-sm text-gray-500">
                                        <i class="fas fa-clock mr-1"></i>
                                        {{ checkin.created_at|timesince }} ago
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            {% endfor %}
        </div>
        
        <!-- Load More Button -->
        {% if has_more %}
            <div class="text-center mt-8">
                <button id="load-more-btn" onclick="loadMoreCheckins()" 
                        class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-8 rounded-lg transition-colors">
                    <i class="fas fa-plus mr-2"></i>
                    Load More Check-ins
                </button>
            </div>
        {% endif %}
        
    {% else %}
        <!-- Empty State -->
        <div class="bg-white rounded-lg shadow-lg p-12 text-center">
            <i class="fas fa-map-pin text-8xl text-gray-300 mb-6"></i>
            <h3 class="text-2xl font-bold text-gray-900 mb-4">No Check-ins Yet</h3>
            <p class="text-gray-600 mb-8 max-w-md mx-auto">
                Be the first to check in at {{ place.name }}! Share your experience and earn points.
            </p>
            
            <div class="space-x-4">
                {% if user.is_authenticated %}
                    <a href="{% url 'places:check_in' place.pk %}" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors">
                        <i class="fas fa-map-pin mr-2"></i>
                        Check In Here
                    </a>
                {% else %}
                    <a href="{% url 'login' %}?next={% url 'places:check_in' place.pk %}" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors">
                        <i class="fas fa-sign-in-alt mr-2"></i>
                        Login to Check In
                    </a>
                {% endif %}
                
                <a href="{% url 'places:place_detail' place.pk %}" class="inline-flex items-center text-green-600 hover:text-green-700 font-medium">
                    <i class="fas fa-eye mr-2"></i>
                    View Place Details
                </a>
            </div>
        </div>
    {% endif %}
</div>

<!-- Photo Modal -->
<div id="photo-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 hidden">
    <div class="max-w-4xl max-h-full p-4 relative">
        <img id="modal-photo" src="" alt="Full size photo" class="max-w-full max-h-full rounded-lg">
        
        <!-- Photo Info -->
        <div class="absolute bottom-4 left-4 bg-black bg-opacity-75 text-white px-4 py-2 rounded-lg">
            <div id="modal-photo-info" class="text-sm"></div>
        </div>
        
        <!-- Close Button -->
        <button class="absolute top-4 right-4 text-white text-2xl hover:text-gray-300 bg-black bg-opacity-50 rounded-full w-10 h-10 flex items-center justify-center" onclick="closePhotoModal()">
            <i class="fas fa-times"></i>
        </button>
        
        <!-- Navigation Arrows (if multiple photos) -->
        <button class="absolute left-4 top-1/2 transform -translate-y-1/2 text-white text-2xl hover:text-gray-300 bg-black bg-opacity-50 rounded-full w-10 h-10 flex items-center justify-center" onclick="previousPhoto()">
            <i class="fas fa-chevron-left"></i>
        </button>
        <button class="absolute right-4 top-1/2 transform -translate-y-1/2 text-white text-2xl hover:text-gray-300 bg-black bg-opacity-50 rounded-full w-10 h-10 flex items-center justify-center" onclick="nextPhoto()">
            <i class="fas fa-chevron-right"></i>
        </button>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<style>
    .filter-btn {
        padding: 0.5rem 0.75rem;
        font-size: 0.875rem;
        font-weight: 500;
        color: #4B5563;
        background-color: #F3F4F6;
        border-radius: 0.5rem;
        transition: background-color 0.2s ease;
        border: none;
        cursor: pointer;
    }
    .filter-btn:hover {
        background-color: #E5E7EB;
    }
    .filter-btn.active {
        background-color: #2563EB;
        color: white;
    }
    .filter-btn.active:hover {
        background-color: #1D4ED8;
    }
    .checkin-item.hidden {
        display: none;
    }
    .checkin-item {
        transition: all 0.3s ease;
    }
    .checkin-item:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
    }
</style>

<script>
    let currentPage = 1;
    let isLoading = false;
    let currentPhotoIndex = 0;
    let allPhotos = [];
    
    // Photo modal functionality
    function openPhotoModal(src, username, date) {
        const modal = document.getElementById('photo-modal');
        const modalPhoto = document.getElementById('modal-photo');
        const modalInfo = document.getElementById('modal-photo-info');
        
        modalPhoto.src = src;
        modalInfo.innerHTML = `Photo by <strong>${username}</strong> on ${date}`;
        modal.classList.remove('hidden');
        
        // Collect all photos for navigation
        allPhotos = Array.from(document.querySelectorAll('.checkin-item img')).map(img => ({
            src: img.src,
            username: img.alt.split(' by ')[1]?.split(' on ')[0] || 'Unknown',
            date: img.alt.split(' on ')[1] || 'Unknown date'
        }));
        
        currentPhotoIndex = allPhotos.findIndex(photo => photo.src === src);
    }
    
    function closePhotoModal() {
        const modal = document.getElementById('photo-modal');
        modal.classList.add('hidden');
    }
    
    function previousPhoto() {
        if (currentPhotoIndex > 0) {
            currentPhotoIndex--;
            updateModalPhoto();
        }
    }
    
    function nextPhoto() {
        if (currentPhotoIndex < allPhotos.length - 1) {
            currentPhotoIndex++;
            updateModalPhoto();
        }
    }
    
    function updateModalPhoto() {
        const modalPhoto = document.getElementById('modal-photo');
        const modalInfo = document.getElementById('modal-photo-info');
        const photo = allPhotos[currentPhotoIndex];
        
        modalPhoto.src = photo.src;
        modalInfo.innerHTML = `Photo by <strong>${photo.username}</strong> on ${photo.date}`;
    }
    
    // Filter functionality
    function filterCheckins(type) {
        const checkins = document.querySelectorAll('.checkin-item');
        const filterBtns = document.querySelectorAll('.filter-btn');
        
        // Update active filter button
        filterBtns.forEach(btn => {
            btn.classList.remove('active');
            if (btn.dataset.filter === type) {
                btn.classList.add('active');
            }
        });
        
        // Show/hide check-ins based on filter
        checkins.forEach(checkin => {
            let shouldShow = false;
            
            switch (type) {
                case 'all':
                    shouldShow = true;
                    break;
                case 'verified':
                    shouldShow = checkin.dataset.verified === 'true';
                    break;
                case 'photos':
                    shouldShow = checkin.dataset.hasPhoto === 'true';
                    break;
                case 'recent':
                    const checkinDate = new Date(checkin.dataset.date);
                    const weekAgo = new Date();
                    weekAgo.setDate(weekAgo.getDate() - 7);
                    shouldShow = checkinDate >= weekAgo;
                    break;
            }
            
            if (shouldShow) {
                checkin.classList.remove('hidden');
                checkin.style.display = 'block';
            } else {
                checkin.classList.add('hidden');
                checkin.style.display = 'none';
            }
        });
        
        // Update counts
        updateFilterCounts();
    }
    
    // Sort functionality
    function sortCheckins() {
        const sortValue = document.getElementById('sort-select').value;
        const checkinsContainer = document.getElementById('checkins-list');
        const checkins = Array.from(checkinsContainer.children);
        
        checkins.sort((a, b) => {
            switch (sortValue) {
                case 'newest':
                    return new Date(b.dataset.date) - new Date(a.dataset.date);
                case 'oldest':
                    return new Date(a.dataset.date) - new Date(b.dataset.date);
                case 'verified':
                    return (b.dataset.verified === 'true') - (a.dataset.verified === 'true');
                case 'photos':
                    return (b.dataset.hasPhoto === 'true') - (a.dataset.hasPhoto === 'true');
                case 'rating':
                    return parseInt(b.dataset.rating) - parseInt(a.dataset.rating);
                default:
                    return 0;
            }
        });
        
        // Re-append sorted elements
        checkins.forEach(checkin => checkinsContainer.appendChild(checkin));
    }
    
    // Update filter counts
    function updateFilterCounts() {
        const allCheckins = document.querySelectorAll('.checkin-item');
        const verifiedCheckins = document.querySelectorAll('.checkin-item[data-verified="true"]');
        const photoCheckins = document.querySelectorAll('.checkin-item[data-has-photo="true"]');
        
        const weekAgo = new Date();
        weekAgo.setDate(weekAgo.getDate() - 7);
        const recentCheckins = Array.from(allCheckins).filter(checkin => 
            new Date(checkin.dataset.date) >= weekAgo
        );
        
        // Update button text (if needed)
        document.querySelector('[data-filter="all"]').textContent = `All (${allCheckins.length})`;
        document.querySelector('[data-filter="verified"]').textContent = `Verified (${verifiedCheckins.length})`;
        document.querySelector('[data-filter="photos"]').textContent = `With Photos (${photoCheckins.length})`;
        document.querySelector('[data-filter="recent"]').textContent = `Recent (${recentCheckins.length})`;
    }
    
    // Like check-in
    function likeCheckin(checkinId) {
        fetch(`/api/checkins/${checkinId}/like/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Update like count and button state
                const likeBtn = document.querySelector(`button[onclick="likeCheckin(${checkinId})"]`);
                const likeCount = likeBtn.querySelector('span');
                const likeIcon = likeBtn.querySelector('i');
                
                likeCount.textContent = data.likes;
                
                if (data.liked) {
                    likeIcon.classList.remove('far');
                    likeIcon.classList.add('fas', 'text-red-600');
                    likeBtn.classList.add('text-red-600');
                } else {
                    likeIcon.classList.remove('fas', 'text-red-600');
                    likeIcon.classList.add('far');
                    likeBtn.classList.remove('text-red-600');
                }
                
                // Animation
                likeBtn.classList.add('animate-pulse');
                setTimeout(() => likeBtn.classList.remove('animate-pulse'), 500);
            }
        })
        .catch(error => {
            console.error('Error liking check-in:', error);
        });
    }
    
    // Share check-in
    function shareCheckin(checkinId) {
        const url = `${window.location.origin}/checkin/${checkinId}/`;
        
        if (navigator.share) {
            navigator.share({
                title: 'Check out this check-in on GhostPin',
                url: url
            });
        } else {
            // Fallback: copy to clipboard
            navigator.clipboard.writeText(url).then(() => {
                alert('Link copied to clipboard!');
            });
        }
    }
    
    // Load more check-ins
    function loadMoreCheckins() {
        if (isLoading) return;
        
        isLoading = true;
        const loadMoreBtn = document.getElementById('load-more-btn');
        const originalText = loadMoreBtn.innerHTML;
        
        loadMoreBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Loading...';
        loadMoreBtn.disabled = true;
        
        fetch(`${window.location.pathname}?page=${currentPage + 1}`, {
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.text())
        .then(html => {
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');
            const newCheckins = doc.querySelectorAll('.checkin-item');
            const checkinsContainer = document.getElementById('checkins-list');
            
            if (newCheckins.length > 0) {
                newCheckins.forEach((checkin, index) => {
                    checkin.style.opacity = '0';
                    checkin.style.transform = 'translateY(20px)';
                    checkinsContainer.appendChild(checkin);
                    
                    setTimeout(() => {
                        checkin.style.transition = 'opacity 0.5s ease, transform 0.5s ease';
                        checkin.style.opacity = '1';
                        checkin.style.transform = 'translateY(0)';
                    }, index * 100);
                });
                
                currentPage++;
                
                // Check if there are more pages
                const hasMore = doc.querySelector('#load-more-btn');
                if (!hasMore) {
                    loadMoreBtn.style.display = 'none';
                }
            } else {
                loadMoreBtn.style.display = 'none';
            }
        })
        .catch(error => {
            console.error('Error loading more check-ins:', error);
        })
        .finally(() => {
            isLoading = false;
            loadMoreBtn.innerHTML = originalText;
            loadMoreBtn.disabled = false;
        });
    }
    
    // Keyboard shortcuts
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            closePhotoModal();
        } else if (e.key === 'ArrowLeft') {
            previousPhoto();
        } else if (e.key === 'ArrowRight') {
            nextPhoto();
        }
    });
    
    // Close modal when clicking outside
    document.getElementById('photo-modal').addEventListener('click', function(e) {
        if (e.target === this) {
            closePhotoModal();
        }
    });
    
    // Initialize page
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize filter counts
        updateFilterCounts();
        
        // Add smooth scrolling
        document.querySelectorAll('a[href^="#"]').forEach(anchor => {
            anchor.addEventListener('click', function (e) {
                e.preventDefault();
                document.querySelector(this.getAttribute('href')).scrollIntoView({
                    behavior: 'smooth'
                });
            });
        });
        
        // Animate check-ins on load
        const checkins = document.querySelectorAll('.checkin-item');
        checkins.forEach((checkin, index) => {
            checkin.style.opacity = '0';
            checkin.style.transform = 'translateY(20px)';
            
            setTimeout(() => {
                checkin.style.transition = 'opacity 0.5s ease, transform 0.5s ease';
                checkin.style.opacity = '1';
                checkin.style.transform = 'translateY(0)';
            }, index * 100);
        });
    });
</script>
{% endblock %}

