{% extends 'base.html' %}

{% block title %}Nearby Places - GhostPin{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto">
    <!-- Header -->
    <div class="text-center mb-8">
        <h1 class="text-3xl font-bold text-gray-900 mb-4">
            <i class="fas fa-location-arrow text-blue-600 mr-2"></i>
            Places Near You
        </h1>
        <p class="text-gray-600 max-w-2xl mx-auto">
            Discover historical places in your area. We'll use your location to find interesting places nearby.
        </p>
    </div>

    <!-- Location Status -->
    <div id="location-status" class="bg-white rounded-lg shadow-lg p-6 mb-8">
        <div class="flex items-center justify-between">
            <div class="flex items-center space-x-3">
                <div id="location-icon" class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center">
                    <i class="fas fa-crosshairs text-blue-600 text-xl"></i>
                </div>
                <div>
                    <h3 id="location-title" class="text-lg font-semibold text-gray-900">Getting your location...</h3>
                    <p id="location-subtitle" class="text-gray-600">Please allow location access to find nearby places</p>
                </div>
            </div>
            <button id="get-location-btn" class="btn-primary" onclick="getCurrentLocation()">
                <i class="fas fa-crosshairs mr-2"></i>
                Get My Location
            </button>
        </div>
    </div>

    <!-- Weather Info -->
    <div id="weather-info" class="bg-gradient-to-r from-blue-400 to-blue-600 rounded-lg p-6 text-white mb-8 hidden">
        <div class="flex items-center justify-between">
            <div class="flex items-center space-x-4">
                <div id="weather-icon" class="text-4xl">☀️</div>
                <div>
                    <h3 id="weather-location" class="text-lg font-semibold">Current Weather</h3>
                    <p id="weather-description" class="text-blue-100">Loading weather...</p>
                </div>
            </div>
            <div class="text-right">
                <div id="weather-temp" class="text-3xl font-bold">--°</div>
                <div id="weather-feels-like" class="text-blue-100 text-sm">Feels like --°</div>
            </div>
        </div>
    </div>

    <!-- Distance Filter -->
    <div class="bg-white rounded-lg shadow-lg p-6 mb-8">
        <div class="flex flex-col sm:flex-row items-center justify-between gap-4">
            <h3 class="text-lg font-semibold text-gray-900">
                <i class="fas fa-ruler text-purple-600 mr-2"></i>
                Search Radius
            </h3>
            <div class="flex items-center space-x-4">
                <label class="text-sm font-medium text-gray-700">Distance:</label>
                <select id="distance-filter" class="border border-gray-300 rounded-md px-3 py-2" onchange="updateNearbyPlaces()">
                    <option value="5">Within 5 km</option>
                    <option value="10" selected>Within 10 km</option>
                    <option value="25">Within 25 km</option>
                    <option value="50">Within 50 km</option>
                    <option value="100">Within 100 km</option>
                </select>
                <button class="btn-secondary" onclick="updateNearbyPlaces()">
                    <i class="fas fa-sync mr-1"></i> Refresh
                </button>
            </div>
        </div>
    </div>

    <!-- Map and Results -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
        <!-- Interactive Map -->
        <div class="bg-white rounded-lg shadow-lg p-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">
                <i class="fas fa-map text-green-600 mr-2"></i>
                Interactive Map
            </h3>
            <div id="nearby-map" class="w-full h-96 rounded-lg"></div>
            <div class="mt-4 flex items-center justify-between text-sm text-gray-600">
                <span>
                    <i class="fas fa-info-circle mr-1"></i>
                    Click markers for details
                </span>
                <span id="places-count">0 places found</span>
            </div>
        </div>

        <!-- Places List -->
        <div class="space-y-6" id="nearby-places-list">
            <!-- Loading State -->
            <div id="loading-places" class="text-center py-12">
                <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-green-600 mx-auto mb-4"></div>
                <p class="text-gray-600">Finding places near you...</p>
            </div>

            <!-- No Location State -->
            <div id="no-location" class="text-center py-12 hidden">
                <i class="fas fa-location-slash text-6xl text-gray-300 mb-4"></i>
                <h3 class="text-xl font-medium text-gray-900 mb-2">Location Required</h3>
                <p class="text-gray-600 mb-6">
                    We need your location to find nearby historical places. 
                    Please enable location services and try again.
                </p>
                <button class="btn-primary" onclick="getCurrentLocation()">
                    <i class="fas fa-crosshairs mr-2"></i> Enable Location
                </button>
            </div>

            <!-- No Places State -->
            <div id="no-places" class="text-center py-12 hidden">
                <i class="fas fa-map-marker-alt text-6xl text-gray-300 mb-4"></i>
                <h3 class="text-xl font-medium text-gray-900 mb-2">No Places Nearby</h3>
                <p class="text-gray-600 mb-6">
                    We couldn't find any historical places in your area. 
                    Try increasing the search radius or explore other areas.
                </p>
                <div class="space-x-4">
                    <button class="btn-secondary" onclick="increaseRadius()">
                        <i class="fas fa-expand-arrows-alt mr-2"></i> Expand Search
                    </button>
                    {% if user.is_authenticated %}
                        <a href="{% url 'add_place' %}" class="btn-primary">
                            <i class="fas fa-plus mr-2"></i> Add a Place
                        </a>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Actions -->
    <div class="mt-12 bg-white rounded-lg shadow-lg p-8">
        <h2 class="text-2xl font-bold text-gray-900 mb-6">
            <i class="fas fa-bolt text-yellow-500 mr-2"></i>
            Quick Actions
        </h2>
        
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <div class="text-center p-6 bg-green-50 rounded-lg">
                <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-route text-green-600 text-2xl"></i>
                </div>
                <h3 class="font-semibold text-lg mb-2">Plan Route</h3>
                <p class="text-gray-600 text-sm mb-4">Create a route visiting multiple nearby places</p>
                <button class="btn-primary w-full" onclick="planRoute()">
                    <i class="fas fa-route mr-2"></i> Plan Route
                </button>
            </div>
            
            <div class="text-center p-6 bg-blue-50 rounded-lg">
                <div class="w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-camera text-blue-600 text-2xl"></i>
                </div>
                <h3 class="font-semibold text-lg mb-2">Photo Challenge</h3>
                <p class="text-gray-600 text-sm mb-4">Take photos at nearby places for points</p>
                <button class="btn-primary w-full" onclick="startPhotoChallenge()">
                    <i class="fas fa-camera mr-2"></i> Start Challenge
                </button>
            </div>
            
            <div class="text-center p-6 bg-purple-50 rounded-lg">
                <div class="w-16 h-16 bg-purple-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-share text-purple-600 text-2xl"></i>
                </div>
                <h3 class="font-semibold text-lg mb-2">Share Location</h3>
                <p class="text-gray-600 text-sm mb-4">Share your current area with friends</p>
                <button class="btn-primary w-full" onclick="shareLocation()">
                    <i class="fas fa-share mr-2"></i> Share
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let nearbyMap;
    let userLocation = null;
    let nearbyPlaces = [];
    let markers = [];
    
    // Initialize map
    function initNearbyMap() {
        nearbyMap = L.map('nearby-map').setView([40.7128, -74.0060], 13);
        
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap contributors'
        }).addTo(nearbyMap);
    }
    
    // Get current location
    function getCurrentLocation() {
        const statusIcon = document.getElementById('location-icon');
        const statusTitle = document.getElementById('location-title');
        const statusSubtitle = document.getElementById('location-subtitle');
        const getLocationBtn = document.getElementById('get-location-btn');
        
        statusIcon.innerHTML = '<i class="fas fa-spinner fa-spin text-blue-600 text-xl"></i>';
        statusTitle.textContent = 'Getting your location...';
        statusSubtitle.textContent = 'Please wait while we locate you';
        getLocationBtn.disabled = true;
        
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                function(position) {
                    userLocation = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude
                    };
                    
                    statusIcon.innerHTML = '<i class="fas fa-check-circle text-green-600 text-xl"></i>';
                    statusTitle.textContent = 'Location found!';
                    statusSubtitle.textContent = `Lat: ${userLocation.lat.toFixed(4)}, Lng: ${userLocation.lng.toFixed(4)}`;
                    getLocationBtn.textContent = 'Update Location';
                    getLocationBtn.disabled = false;
                    
                    // Update map
                    nearbyMap.setView([userLocation.lat, userLocation.lng], 13);
                    
                    // Add user location marker
                    L.marker([userLocation.lat, userLocation.lng], {
                        icon: L.divIcon({
                            className: 'user-location-marker',
                            html: '<div class="w-4 h-4 bg-blue-600 rounded-full border-2 border-white shadow-lg"></div>',
                            iconSize: [16, 16],
                            iconAnchor: [8, 8]
                        })
                    }).addTo(nearbyMap).bindPopup('Your Location');
                    
                    // Get weather and nearby places
                    getWeatherInfo(userLocation.lat, userLocation.lng);
                    updateNearbyPlaces();
                },
                function(error) {
                    statusIcon.innerHTML = '<i class="fas fa-exclamation-triangle text-red-600 text-xl"></i>';
                    statusTitle.textContent = 'Location access denied';
                    statusSubtitle.textContent = 'Please enable location services and try again';
                    getLocationBtn.disabled = false;
                    
                    document.getElementById('no-location').classList.remove('hidden');
                    document.getElementById('loading-places').classList.add('hidden');
                }
            );
        } else {
            statusIcon.innerHTML = '<i class="fas fa-times-circle text-red-600 text-xl"></i>';
            statusTitle.textContent = 'Location not supported';
            statusSubtitle.textContent = 'Your browser does not support geolocation';
            getLocationBtn.disabled = false;
        }
    }
    
    // Get weather information
    function getWeatherInfo(lat, lng) {
        // Mock weather data - in real implementation, use weather API
        const weatherInfo = document.getElementById('weather-info');
        const weatherIcon = document.getElementById('weather-icon');
        const weatherLocation = document.getElementById('weather-location');
        const weatherDescription = document.getElementById('weather-description');
        const weatherTemp = document.getElementById('weather-temp');
        const weatherFeelsLike = document.getElementById('weather-feels-like');
        
        // Simulate weather API call
        setTimeout(() => {
            weatherIcon.textContent = '☀️';
            weatherLocation.textContent = 'Current Location';
            weatherDescription.textContent = 'Perfect weather for exploring!';
            weatherTemp.textContent = '24°C';
            weatherFeelsLike.textContent = 'Feels like 26°C';
            weatherInfo.classList.remove('hidden');
        }, 1000);
    }
    
    // Update nearby places
    function updateNearbyPlaces() {
        if (!userLocation) {
            getCurrentLocation();
            return;
        }
        
        const distance = document.getElementById('distance-filter').value;
        const loadingPlaces = document.getElementById('loading-places');
        const nearbyPlacesList = document.getElementById('nearby-places-list');
        
        loadingPlaces.classList.remove('hidden');
        
        // Clear existing markers
        markers.forEach(marker => nearbyMap.removeLayer(marker));
        markers = [];
        
        // Mock API call to get nearby places
        setTimeout(() => {
            // In real implementation, make AJAX call to Django view
            const mockPlaces = [
                {
                    id: 1,
                    name: "Historic Monument",
                    description: "A beautiful historic monument with rich history...",
                    category: "monument",
                    category_icon: "🏛️",
                    latitude: userLocation.lat + 0.01,
                    longitude: userLocation.lng + 0.01,
                    distance: 1.2,
                    rating: 4.5,
                    visit_count: 234
                },
                {
                    id: 2,
                    name: "Ancient Temple",
                    description: "An ancient temple dating back centuries...",
                    category: "temple",
                    category_icon: "🕌",
                    latitude: userLocation.lat - 0.015,
                    longitude: userLocation.lng + 0.02,
                    distance: 2.8,
                    rating: 4.2,
                    visit_count: 156
                }
            ];
            
            displayNearbyPlaces(mockPlaces);
            loadingPlaces.classList.add('hidden');
        }, 1500);
    }
    
    // Display nearby places
    function displayNearbyPlaces(places) {
        const nearbyPlacesList = document.getElementById('nearby-places-list');
        const placesCount = document.getElementById('places-count');
        const noPlaces = document.getElementById('no-places');
        
        if (places.length === 0) {
            noPlaces.classList.remove('hidden');
            placesCount.textContent = '0 places found';
            return;
        }
        
        placesCount.textContent = `${places.length} places found`;
        
        let html = '';
        places.forEach(place => {
            // Add marker to map
            const marker = L.marker([place.latitude, place.longitude])
                .bindPopup(`
                    <div class="text-center">
                        <div class="text-2xl mb-2">${place.category_icon}</div>
                        <h3 class="font-semibold">${place.name}</h3>
                        <p class="text-sm text-gray-600 mt-1">${place.distance} km away</p>
                        <a href="/places/${place.id}/" class="text-green-600 hover:text-green-800 text-sm">View Details →</a>
                    </div>
                `)
                .addTo(nearbyMap);
            markers.push(marker);
            
            // Add to list
            html += `
                <div class="bg-white rounded-lg shadow-lg p-6 card-hover">
                    <div class="flex items-start justify-between mb-3">
                        <h3 class="text-xl font-bold text-gray-900">${place.name}</h3>
                        <div class="text-right">
                            <div class="text-sm font-semibold text-blue-600">${place.distance} km</div>
                            <div class="text-xs text-gray-500">away</div>
                        </div>
                    </div>
                    
                    <p class="text-gray-600 mb-4">${place.description}</p>
                    
                    <div class="flex items-center justify-between mb-4">
                        <div class="flex items-center space-x-3">
                            <span class="bg-${place.category}-100 text-${place.category}-800 text-xs font-semibold px-2.5 py-0.5 rounded-full">
                                ${place.category_icon} ${place.category}
                            </span>
                            <span class="flex items-center text-sm text-gray-500">
                                <i class="fas fa-star text-yellow-500 mr-1"></i>
                                ${place.rating}
                            </span>
                            <span class="flex items-center text-sm text-gray-500">
                                <i class="fas fa-eye mr-1"></i>
                                ${place.visit_count}
                            </span>
                        </div>
                    </div>
                    
                    <div class="flex space-x-3">
                        <a href="/places/${place.id}/" class="flex-1 btn-primary text-center">
                            <i class="fas fa-eye mr-1"></i> View Details
                        </a>
                        <button class="btn-secondary" onclick="getDirections(${place.latitude}, ${place.longitude})">
                            <i class="fas fa-directions mr-1"></i> Directions
                        </button>
                    </div>
                </div>
            `;
        });
        
        nearbyPlacesList.innerHTML = html;
        
        // Fit map to show all places
        if (places.length > 0) {
            const bounds = L.latLngBounds();
            bounds.extend([userLocation.lat, userLocation.lng]);
            places.forEach(place => {
                bounds.extend([place.latitude, place.longitude]);
            });
            nearbyMap.fitBounds(bounds, { padding: [20, 20] });
        }
    }
    
    // Get directions to a place
    function getDirections(lat, lng) {
        if (userLocation) {
            const url = `https://www.google.com/maps/dir/${userLocation.lat},${userLocation.lng}/${lat},${lng}`;
            window.open(url, '_blank');
        }
    }
    
    // Increase search radius
    function increaseRadius() {
        const distanceFilter = document.getElementById('distance-filter');
        const currentValue = parseInt(distanceFilter.value);
        const options = [5, 10, 25, 50, 100];
        const currentIndex = options.indexOf(currentValue);
        
        if (currentIndex < options.length - 1) {
            distanceFilter.value = options[currentIndex + 1];
            updateNearbyPlaces();
        }
    }
    
    // Plan route with multiple places
    function planRoute() {
        alert('Route planning feature coming soon!');
    }
    
    // Start photo challenge
    function startPhotoChallenge() {
        alert('Photo challenge feature coming soon!');
    }
    
    // Share current location
    function shareLocation() {
        if (navigator.share && userLocation) {
            navigator.share({
                title: 'Check out these places near me!',
                text: 'I found some interesting historical places in my area.',
                url: window.location.href
            });
        } else {
            // Fallback to copying URL
            navigator.clipboard.writeText(window.location.href);
            alert('Location URL copied to clipboard!');
        }
    }
    
    // Initialize when page loads
    document.addEventListener('DOMContentLoaded', function() {
        initNearbyMap();
        getCurrentLocation();
    });
</script>
{% endblock %}

