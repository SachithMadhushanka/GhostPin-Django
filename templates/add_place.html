{% extends 'base.html' %}

{% block title %}Add New Place - GhostPin{% endblock %}

{% block content %}
<div class="max-w-2xl mx-auto">
    <!-- Header -->
    <div class="text-center mb-8">
        <h1 class="text-3xl md:text-4xl font-bold text-gray-800 mb-4">
            üìç Add New Historical Place
        </h1>
        <p class="text-gray-600">
            Share a fascinating historical location with our community. Your submission will be reviewed before being published.
        </p>
    </div>

    <!-- Form -->
    <div class="bg-white rounded-lg shadow-lg p-6 md:p-8">
        <form method="post" enctype="multipart/form-data" class="space-y-6">
            {% csrf_token %}
            {% if form.errors %}
            <div class="bg-red-50 border border-red-200 rounded-lg p-4 mb-6">
                <h3 class="text-sm font-medium text-red-800 mb-2">Please correct the following errors:</h3>
                <ul class="text-sm text-red-700 list-disc list-inside space-y-1">
                    {% for field, errors in form.errors.items %}
                        {% for error in errors %}
                            <li><strong>{{ field|title }}:</strong> {{ error }}</li>
                        {% endfor %}
                    {% endfor %}
                    {% for error in form.non_field_errors %}
                        <li>{{ error }}</li>
                    {% endfor %}
                </ul>
            </div>
            {% endif %}

            <!-- Place Name -->
            <div>
                <label for="{{ form.name.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                    Place Name *
                </label>
                {{ form.name }}
                {% if form.name.errors %}
                    <p class="mt-1 text-sm text-red-600">{{ form.name.errors.0 }}</p>
                {% endif %}
            </div>

            <!-- Description -->
            <div>
                <label for="{{ form.description.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                    Description *
                </label>
                {{ form.description }}
                <p class="mt-1 text-sm text-gray-500">
                    Tell us about the historical significance of this place. What makes it special?
                </p>
                {% if form.description.errors %}
                    <p class="mt-1 text-sm text-red-600">{{ form.description.errors.0 }}</p>
                {% endif %}
            </div>
            <!-- Category -->
            <div>
                <label for="{{ form.category.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                    Category *
                </label>
                {{ form.category }}
                {% if form.category.errors %}
                    <p class="mt-1 text-sm text-red-600">{{ form.category.errors.0 }}</p>
                {% endif %}
            </div>

            <!-- Category Icon -->
            <!-- <div>
                <label for="{{ form.category_icon.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                    Category Icon *
                </label>
                {{ form.category_icon }}
                {% if form.category_icon.errors %}
                    <p class="mt-1 text-sm text-red-600">{{ form.category_icon.errors.0 }}</p>
                {% endif %}
            </div> -->

            <!-- Difficulty -->
            <div>
                <label for="{{ form.difficulty.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                    Difficulty *
                </label>
                {{ form.difficulty }}
                {% if form.difficulty.errors %}
                    <p class="mt-1 text-sm text-red-600">{{ form.difficulty.errors.0 }}</p>
                {% endif %}
            </div>

            <!-- Safety Rating -->
            <div>
                <label for="{{ form.safety_rating.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                    Safety Rating *
                </label>
                {{ form.safety_rating }}
                {% if form.safety_rating.errors %}
                    <p class="mt-1 text-sm text-red-600">{{ form.safety_rating.errors.0 }}</p>
                {% endif %}
            </div>

            <!-- Best Time to Visit -->
            <div>
                <label for="{{ form.best_time_to_visit.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                    Best Time to Visit
                </label>
                {{ form.best_time_to_visit }}
                {% if form.best_time_to_visit.errors %}
                    <p class="mt-1 text-sm text-red-600">{{ form.best_time_to_visit.errors.0 }}</p>
                {% endif %}
                <p class="mt-2 text-sm text-gray-500">When is the best time to visit this place?</p>
            </div>

            <!-- Accessibility Information -->
            <div>
                <label for="{{ form.accessibility_info.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                    Accessibility & Visitor Information
                </label>
                {{ form.accessibility_info }}
                {% if form.accessibility_info.errors %}
                    <p class="mt-1 text-sm text-red-600">{{ form.accessibility_info.errors.0 }}</p>
                {% endif %}
                <p class="mt-2 text-sm text-gray-500">Include important information for visitors, such as wheelchair access, required attire (e.g., modest dress), entrance rules, or other cultural or religious considerations.</p>
            </div>

            <!-- Legends and Stories -->
            <div>
                <label for="{{ form.legends_stories.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                    Legends & Stories
                </label>
                {{ form.legends_stories }}
                {% if form.legends_stories.errors %}
                    <p class="mt-1 text-sm text-red-600">{{ form.legends_stories.errors.0 }}</p>
                {% endif %}
                <p class="mt-2 text-sm text-gray-500">Share any legends, stories, or folklore associated with this place</p>
            </div>

            <!-- Location -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label for="{{ form.latitude.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                        Latitude *
                    </label>
                    {{ form.latitude }}
                    {% if form.latitude.errors %}
                        <p class="mt-1 text-sm text-red-600">{{ form.latitude.errors.0 }}</p>
                    {% endif %}
                </div>
                <div>
                    <label for="{{ form.longitude.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                        Longitude *
                    </label>
                    {{ form.longitude }}
                    {% if form.longitude.errors %}
                        <p class="mt-1 text-sm text-red-600">{{ form.longitude.errors.0 }}</p>
                    {% endif %}
                </div>
            </div>
            
            <!-- Location Helper -->
            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                <div class="flex items-start">
                    <div class="flex-shrink-0">
                        <svg class="h-5 w-5 text-blue-400" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
                        </svg>
                    </div>
                    <div class="ml-3">
                        <h3 class="text-sm font-medium text-blue-800">Need help finding coordinates?</h3>
                        <div class="mt-2 text-sm text-blue-700">
                            <p>You can find latitude and longitude coordinates by:</p>
                            <ul class="list-disc list-inside mt-1 space-y-1">
                                <li>Right-clicking on Google Maps and selecting the coordinates</li>
                                <li>Using GPS coordinates from your phone</li>
                                <li>Searching online for "[Place Name] coordinates"</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Map for Selecting Location -->
            <div class="bg-gray-50 rounded-lg p-4 mt-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-3">
                    <i class="fas fa-map text-green-600 mr-2"></i>
                    Select Location on Map
                </h3>
                <div id="add-map" class="w-full h-64 rounded-lg"></div>
                <p class="mt-2 text-sm text-gray-600">Click on the map to set the location coordinates</p>
            </div>

            <!-- Image Upload -->
            <div>
                <label for="{{ form.image.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                    Image (Optional)
                </label>
                {{ form.image }}
                <p class="mt-1 text-sm text-gray-500">
                    Upload a photo of the historical place. This helps others visualize the location.
                </p>
                {% if form.image.errors %}
                    <p class="mt-1 text-sm text-red-600">{{ form.image.errors.0 }}</p>
                {% endif %}
            </div>

            <!-- Submit Button -->
            <div class="flex items-center justify-between pt-6">
                <a href="{% url 'places:home' %}" class="text-gray-600 hover:text-gray-800 font-medium">
                    Cancel
                </a>
                <button type="submit" class="btn-primary text-white px-8 py-3 rounded-lg font-semibold">
                    Submit Place for Review
                </button>
            </div>
        </form>
    </div>

    <!-- Guidelines -->
    <div class="mt-8 bg-gray-50 rounded-lg p-6">
        <h3 class="text-lg font-medium text-gray-800 mb-4">üìã Submission Guidelines</h3>
        <ul class="space-y-2 text-sm text-gray-600">
            <li class="flex items-start">
                <span class="text-green-500 mr-2">‚úì</span>
                Ensure the place has genuine historical significance
            </li>
            <li class="flex items-start">
                <span class="text-green-500 mr-2">‚úì</span>
                Provide accurate coordinates and detailed description
            </li>
            <li class="flex items-start">
                <span class="text-green-500 mr-2">‚úì</span>
                Use your own photos or images with proper permissions
            </li>
            <li class="flex items-start">
                <span class="text-green-500 mr-2">‚úì</span>
                Be respectful and factual in your descriptions
            </li>
        </ul>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let addMap;
    let addMarker;

    function initAddMap() {
        // Default center (can be changed to your region)
        const defaultLat = 6.865349;  // Example: Sri Lanka
        const defaultLng = 80.024414;

        addMap = L.map('add-map').setView([defaultLat, defaultLng], 5);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '¬© OpenStreetMap contributors'
        }).addTo(addMap);

        // Add marker when user clicks on map
        addMap.on('click', function (e) {
            const lat = e.latlng.lat.toFixed(6);
            const lng = e.latlng.lng.toFixed(6);

            if (addMarker) {
                addMarker.setLatLng(e.latlng);
            } else {
                addMarker = L.marker(e.latlng, { draggable: true }).addTo(addMap);
                addMarker.on('dragend', updateCoordsFromMarker);
            }

            document.getElementById('{{ form.latitude.id_for_label }}').value = lat;
            document.getElementById('{{ form.longitude.id_for_label }}').value = lng;
        });

        // Update map when coords are manually typed
        document.getElementById('{{ form.latitude.id_for_label }}').addEventListener('change', updateMapFromInputs);
        document.getElementById('{{ form.longitude.id_for_label }}').addEventListener('change', updateMapFromInputs);
    }

    function updateCoordsFromMarker(e) {
        const position = e.target.getLatLng();
        document.getElementById('{{ form.latitude.id_for_label }}').value = position.lat.toFixed(6);
        document.getElementById('{{ form.longitude.id_for_label }}').value = position.lng.toFixed(6);
    }

    function updateMapFromInputs() {
        const lat = parseFloat(document.getElementById('{{ form.latitude.id_for_label }}').value);
        const lng = parseFloat(document.getElementById('{{ form.longitude.id_for_label }}').value);

        if (!isNaN(lat) && !isNaN(lng)) {
            const newLatLng = [lat, lng];
            addMap.setView(newLatLng, 13);

            if (addMarker) {
                addMarker.setLatLng(newLatLng);
            } else {
                addMarker = L.marker(newLatLng, { draggable: true }).addTo(addMap);
                addMarker.on('dragend', updateCoordsFromMarker);
            }
        }
    }

    document.addEventListener("DOMContentLoaded", function () {
        initAddMap();
    });
</script>
{% endblock %}

